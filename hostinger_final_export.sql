-- ================================================
-- Hostinger Database Export
-- Generated: 2025-09-06 13:50:32
-- Database: japanese_lms
-- ================================================

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;
SET SQL_MODE = 'NO_AUTO_VALUE_ON_ZERO';
SET AUTOCOMMIT = 0;
START TRANSACTION;
SET time_zone = '+00:00';

-- Table structure for table `admin_action_logs`
DROP TABLE IF EXISTS `admin_action_logs`;
CREATE TABLE `admin_action_logs` ( `id` int(11) NOT NULL AUTO_INCREMENT, `admin_id` int(11) NOT NULL, `user_id` int(11) NOT NULL, `action` varchar(50) NOT NULL, `details` text DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `admin_id` (`admin_id`), KEY `user_id` (`user_id`), CONSTRAINT `admin_action_logs_ibfk_1` FOREIGN KEY (`admin_id`) REFERENCES `users` (`id`) ON DELETE CASCADE, CONSTRAINT `admin_action_logs_ibfk_2` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `admin_audit_log`
DROP TABLE IF EXISTS `admin_audit_log`;
CREATE TABLE `admin_audit_log` ( `id` int(11) NOT NULL AUTO_INCREMENT, `admin_id` int(11) NOT NULL, `action` varchar(100) NOT NULL, `details` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`details`)), `ip_address` varchar(45) NOT NULL, `user_agent` text DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `idx_admin_id` (`admin_id`), KEY `idx_action` (`action`), KEY `idx_created_at` (`created_at`), CONSTRAINT `admin_audit_log_ibfk_1` FOREIGN KEY (`admin_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `admin_dashboard_preferences`
DROP TABLE IF EXISTS `admin_dashboard_preferences`;
CREATE TABLE `admin_dashboard_preferences` ( `id` int(11) NOT NULL AUTO_INCREMENT, `admin_id` int(11) NOT NULL, `theme` enum('light','dark') DEFAULT 'light', `layout_config` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`layout_config`)), `notification_settings` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`notification_settings`)), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_admin_prefs` (`admin_id`), CONSTRAINT `admin_dashboard_preferences_ibfk_1` FOREIGN KEY (`admin_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `admin_logs`
DROP TABLE IF EXISTS `admin_logs`;
CREATE TABLE `admin_logs` ( `id` int(11) NOT NULL AUTO_INCREMENT, `admin_id` int(11) NOT NULL, `action` varchar(50) NOT NULL, `action_detail` text DEFAULT NULL, `created_at` datetime NOT NULL, PRIMARY KEY (`id`), KEY `admin_id` (`admin_id`), CONSTRAINT `admin_logs_ibfk_1` FOREIGN KEY (`admin_id`) REFERENCES `users` (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `announcement_banner`
DROP TABLE IF EXISTS `announcement_banner`;
CREATE TABLE `announcement_banner` ( `id` int(11) NOT NULL AUTO_INCREMENT, `content` text NOT NULL, `background_color` varchar(20) DEFAULT '#FFFFFF', `text_color` varchar(20) DEFAULT '#1A1A1A', `button_text` varchar(100) DEFAULT NULL, `button_url` varchar(255) DEFAULT NULL, `button_color` varchar(20) DEFAULT NULL, `button_icon` varchar(50) DEFAULT NULL, `discount_value` varchar(20) DEFAULT NULL, `discount_type` enum('percentage','fixed') DEFAULT 'percentage', `start_date` datetime DEFAULT NULL, `end_date` datetime DEFAULT NULL, `is_published` tinyint(1) DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `audit_config`
DROP TABLE IF EXISTS `audit_config`;
CREATE TABLE `audit_config` ( `id` int(11) NOT NULL AUTO_INCREMENT, `action_type` varchar(50) NOT NULL, `resource_type` varchar(50) NOT NULL, `is_enabled` tinyint(1) DEFAULT 1, `log_level` enum('minimal','standard','detailed') DEFAULT 'standard', `retention_days` int(11) DEFAULT 365, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_audit_config` (`action_type`,`resource_type`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `audit_trail`
DROP TABLE IF EXISTS `audit_trail`;
CREATE TABLE `audit_trail` ( `id` int(11) NOT NULL AUTO_INCREMENT, `course_id` int(11) NOT NULL, `user_id` int(11) NOT NULL, `action` varchar(255) NOT NULL, `details` text DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `user_id` (`user_id`), KEY `audit_trail_ibfk_1` (`course_id`), CONSTRAINT `audit_trail_ibfk_1` FOREIGN KEY (`course_id`) REFERENCES `courses` (`id`) ON DELETE CASCADE, CONSTRAINT `audit_trail_ibfk_2` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `broken_links`
DROP TABLE IF EXISTS `broken_links`;
CREATE TABLE `broken_links` ( `id` int(11) NOT NULL AUTO_INCREMENT, `url` text NOT NULL, `reference_page` varchar(255) DEFAULT NULL, `reference_module` varchar(255) DEFAULT NULL, `first_detected` timestamp NOT NULL DEFAULT current_timestamp(), `last_checked` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), `status_code` int(11) NOT NULL, `severity` enum('critical','warning') NOT NULL DEFAULT 'warning', `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `idx_status_code` (`status_code`), KEY `idx_severity` (`severity`), KEY `idx_last_checked` (`last_checked`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Table structure for table `categories`
DROP TABLE IF EXISTS `categories`;
CREATE TABLE `categories` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(255) NOT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `name` (`name`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Table structure for table `chapters`
DROP TABLE IF EXISTS `chapters`;
CREATE TABLE `chapters` ( `id` int(11) NOT NULL AUTO_INCREMENT, `section_id` int(11) NOT NULL DEFAULT 1, `title` varchar(255) NOT NULL, `description` text DEFAULT NULL, `content` text DEFAULT NULL, `content_type` enum('text','video') DEFAULT 'text', `order_index` int(11) NOT NULL DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), `video_url` varchar(500) DEFAULT NULL, `video_type` enum('url','upload') DEFAULT NULL, `video_file_path` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`), KEY `fk_chapters_section_id` (`section_id`), CONSTRAINT `fk_chapters_section_id` FOREIGN KEY (`section_id`) REFERENCES `sections` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `comprehensive_audit_trail`
DROP TABLE IF EXISTS `comprehensive_audit_trail`;
CREATE TABLE `comprehensive_audit_trail` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `timestamp` timestamp NOT NULL DEFAULT current_timestamp(), `user_id` int(11) NOT NULL, `username` varchar(255) NOT NULL, `user_role` enum('student','teacher','admin') NOT NULL, `action_type` enum('CREATE','READ','UPDATE','DELETE','LOGIN','LOGOUT','ACCESS','DOWNLOAD','SUBMIT') NOT NULL, `action_description` text NOT NULL, `resource_type` enum('User Account','Course','Lesson','Chapter','Section','Category','Enrollment','Progress','Quiz','Assignment','Forum Post','Profile','Dashboard','System Config','Materials','Assessment','Application','Payment') NOT NULL, `resource_id` varchar(255) DEFAULT NULL, `resource_name` varchar(500) DEFAULT NULL, `ip_address` varchar(45) NOT NULL, `outcome` enum('Success','Failed','Partial') DEFAULT 'Success', `old_value` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`old_value`)), `new_value` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`new_value`)), `old_value_text` text DEFAULT NULL, `new_value_text` text DEFAULT NULL, `device_info` text DEFAULT NULL, `browser_name` varchar(100) DEFAULT NULL, `operating_system` varchar(100) DEFAULT NULL, `device_type` enum('Desktop','Mobile','Tablet') DEFAULT NULL, `location_country` varchar(100) DEFAULT NULL, `location_city` varchar(100) DEFAULT NULL, `location_ip_info` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`location_ip_info`)), `session_id` varchar(255) DEFAULT NULL, `request_method` enum('GET','POST','PUT','PATCH','DELETE') DEFAULT NULL, `request_url` text DEFAULT NULL, `request_headers` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`request_headers`)), `request_payload` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`request_payload`)), `response_code` int(11) DEFAULT NULL, `response_time_ms` int(11) DEFAULT NULL, `error_message` text DEFAULT NULL, `additional_context` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`additional_context`)), PRIMARY KEY (`id`), KEY `idx_timestamp` (`timestamp`), KEY `idx_user_id` (`user_id`), KEY `idx_username` (`username`), KEY `idx_action_type` (`action_type`), KEY `idx_resource_type` (`resource_type`), KEY `idx_outcome` (`outcome`), KEY `idx_ip_address` (`ip_address`), KEY `idx_session_id` (`session_id`), KEY `idx_user_action` (`user_id`,`action_type`), KEY `idx_date_user` (`timestamp`,`user_id`), KEY `idx_resource_action` (`resource_type`,`action_type`), KEY `idx_comprehensive_user_date` (`user_id`,`timestamp`), KEY `idx_comprehensive_action_outcome` (`action_type`,`outcome`), KEY `idx_comprehensive_resource_date` (`resource_type`,`timestamp`), KEY `idx_comprehensive_ip_date` (`ip_address`,`timestamp`), CONSTRAINT `comprehensive_audit_trail_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `courses`
DROP TABLE IF EXISTS `courses`;
CREATE TABLE `courses` ( `id` int(11) NOT NULL AUTO_INCREMENT, `title` varchar(100) NOT NULL, `description` text DEFAULT NULL, `teacher_id` int(11) DEFAULT NULL, `level` enum('beginner','intermediate','advanced') NOT NULL, `price` decimal(10,2) DEFAULT NULL, `image_path` varchar(255) DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), `is_archived` tinyint(1) NOT NULL DEFAULT 0, `category_id` int(11) DEFAULT NULL, `status` enum('draft','published','archived') NOT NULL DEFAULT 'draft', `is_published` tinyint(1) DEFAULT 0, `published_at` timestamp NULL DEFAULT NULL, `course_category_id` int(11) DEFAULT NULL, PRIMARY KEY (`id`), KEY `idx_courses_teacher` (`teacher_id`), KEY `category_id` (`category_id`), KEY `fk_course_category` (`course_category_id`), CONSTRAINT `courses_ibfk_1` FOREIGN KEY (`teacher_id`) REFERENCES `users` (`id`) ON DELETE SET NULL, CONSTRAINT `courses_ibfk_2` FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`), CONSTRAINT `courses_ibfk_3` FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`) ON DELETE SET NULL, CONSTRAINT `courses_ibfk_4` FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`) ON DELETE SET NULL, CONSTRAINT `courses_ibfk_5` FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`) ON DELETE SET NULL, CONSTRAINT `fk_course_category` FOREIGN KEY (`course_category_id`) REFERENCES `course_category` (`id`) ON DELETE SET NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `course_category`
DROP TABLE IF EXISTS `course_category`;
CREATE TABLE `course_category` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(100) NOT NULL, `description` text DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), `status` enum('active','inactive','deleted') NOT NULL DEFAULT 'active', `deleted_at` timestamp NULL DEFAULT NULL, `restored_at` timestamp NULL DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `name` (`name`), KEY `idx_course_category_name` (`name`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `course_progress`
DROP TABLE IF EXISTS `course_progress`;
CREATE TABLE `course_progress` ( `id` int(11) NOT NULL AUTO_INCREMENT, `course_id` int(11) NOT NULL, `student_id` int(11) NOT NULL, `completed_sections` int(11) DEFAULT 0, `completion_percentage` decimal(5,2) DEFAULT 0.00, `completion_status` enum('not_started','in_progress','completed') DEFAULT 'not_started', `last_accessed_at` timestamp NULL DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_progress` (`course_id`,`student_id`), KEY `student_id` (`student_id`), CONSTRAINT `course_progress_ibfk_1` FOREIGN KEY (`course_id`) REFERENCES `courses` (`id`) ON DELETE CASCADE, CONSTRAINT `course_progress_ibfk_2` FOREIGN KEY (`student_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `dashboard_cache`
DROP TABLE IF EXISTS `dashboard_cache`;
CREATE TABLE `dashboard_cache` ( `cache_key` varchar(255) NOT NULL, `cache_data` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL CHECK (json_valid(`cache_data`)), `expires_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`cache_key`), KEY `idx_expires_at` (`expires_at`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `enrollments`
DROP TABLE IF EXISTS `enrollments`;
CREATE TABLE `enrollments` ( `id` int(11) NOT NULL AUTO_INCREMENT, `course_id` int(11) NOT NULL, `student_id` int(11) NOT NULL, `enrolled_at` timestamp NOT NULL DEFAULT current_timestamp(), `completed_at` timestamp NULL DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `unique_enrollment` (`course_id`,`student_id`), UNIQUE KEY `course_id` (`course_id`,`student_id`), KEY `student_id` (`student_id`), KEY `idx_completed_at` (`completed_at`), KEY `idx_student_completed` (`student_id`,`completed_at`), CONSTRAINT `enrollments_ibfk_1` FOREIGN KEY (`course_id`) REFERENCES `courses` (`id`) ON DELETE CASCADE, CONSTRAINT `enrollments_ibfk_2` FOREIGN KEY (`student_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `failed_login_attempts`
DROP TABLE IF EXISTS `failed_login_attempts`;
CREATE TABLE `failed_login_attempts` ( `id` int(11) NOT NULL AUTO_INCREMENT, `email` varchar(255) DEFAULT NULL, `ip_address` varchar(45) NOT NULL, `user_agent` text DEFAULT NULL, `attempt_time` timestamp NOT NULL DEFAULT current_timestamp(), `reason` enum('invalid_credentials','account_locked','too_many_attempts') DEFAULT 'invalid_credentials', PRIMARY KEY (`id`), KEY `idx_ip_address` (`ip_address`), KEY `idx_attempt_time` (`attempt_time`), KEY `idx_email` (`email`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `login_logs`
DROP TABLE IF EXISTS `login_logs`;
CREATE TABLE `login_logs` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) NOT NULL, `login_time` datetime NOT NULL DEFAULT current_timestamp(), `ip_address` varchar(45) DEFAULT NULL, `user_agent` text DEFAULT NULL, `status` enum('success','failed') NOT NULL DEFAULT 'success', `location` varchar(255) DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `device_type` varchar(50) DEFAULT NULL, `browser_name` varchar(100) DEFAULT NULL, `operating_system` varchar(100) DEFAULT NULL, `session_id` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`), KEY `user_id` (`user_id`), CONSTRAINT `login_logs_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Table structure for table `otps`
DROP TABLE IF EXISTS `otps`;
CREATE TABLE `otps` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) NOT NULL, `email` varchar(255) NOT NULL, `otp_code` varchar(6) NOT NULL, `type` enum('registration','login','password_reset') NOT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `expires_at` timestamp NULL DEFAULT NULL, `is_used` tinyint(1) DEFAULT 0, `verification_token` varchar(64) DEFAULT NULL, PRIMARY KEY (`id`), KEY `user_id` (`user_id`), KEY `idx_otps_verification_token` (`verification_token`), CONSTRAINT `otps_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `otp_cooldowns`
DROP TABLE IF EXISTS `otp_cooldowns`;
CREATE TABLE `otp_cooldowns` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) NOT NULL, `attempt_type` enum('email','sms') NOT NULL, `cooldown_until` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_user_type` (`user_id`,`attempt_type`), KEY `idx_cooldown_until` (`cooldown_until`), CONSTRAINT `otp_cooldowns_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Table structure for table `otp_rate_limits`
DROP TABLE IF EXISTS `otp_rate_limits`;
CREATE TABLE `otp_rate_limits` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) NOT NULL, `phone_number` varchar(20) DEFAULT NULL, `email` varchar(255) DEFAULT NULL, `attempt_type` enum('email','sms') NOT NULL, `attempts_count` int(11) DEFAULT 1, `first_attempt_at` timestamp NOT NULL DEFAULT current_timestamp(), `last_attempt_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), `is_blocked` tinyint(1) DEFAULT 0, `blocked_until` timestamp NULL DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), KEY `idx_user_type` (`user_id`,`attempt_type`), KEY `idx_phone_type` (`phone_number`,`attempt_type`), KEY `idx_email_type` (`email`,`attempt_type`), KEY `idx_last_attempt` (`last_attempt_at`), CONSTRAINT `otp_rate_limits_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Table structure for table `page_performance_log`
DROP TABLE IF EXISTS `page_performance_log`;
CREATE TABLE `page_performance_log` ( `id` int(11) NOT NULL AUTO_INCREMENT, `page_name` varchar(255) NOT NULL, `action_name` varchar(255) DEFAULT NULL, `full_url` text DEFAULT NULL, `start_time` datetime NOT NULL, `end_time` datetime NOT NULL, `load_duration` decimal(8,3) NOT NULL, `status` enum('fast','slow','timeout','error') NOT NULL, `user_id` int(11) DEFAULT NULL, `session_id` varchar(128) DEFAULT NULL, `ip_address` varchar(45) DEFAULT NULL, `user_agent` text DEFAULT NULL, `device_type` varchar(50) DEFAULT NULL, `browser` varchar(100) DEFAULT NULL, `os` varchar(100) DEFAULT NULL, `memory_usage` varchar(20) DEFAULT NULL, `query_count` int(11) DEFAULT 0, `response_code` int(3) DEFAULT 200, `error_message` text DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `idx_page_name` (`page_name`), KEY `idx_load_duration` (`load_duration`), KEY `idx_status` (`status`), KEY `idx_user_id` (`user_id`), KEY `idx_start_time` (`start_time`), KEY `idx_created_at` (`created_at`), CONSTRAINT `page_performance_log_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `payments`
DROP TABLE IF EXISTS `payments`;
CREATE TABLE `payments` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) NOT NULL, `course_id` int(11) NOT NULL, `amount` decimal(10,2) NOT NULL, `payment_status` varchar(50) NOT NULL, `payment_date` datetime DEFAULT current_timestamp(), `paymongo_id` varchar(255) DEFAULT NULL, `invoice_number` varchar(50) NOT NULL, `payment_type` varchar(20) NOT NULL DEFAULT 'PAID', `status` enum('pending','completed','failed','refunded') DEFAULT 'pending', PRIMARY KEY (`id`), KEY `course_id` (`course_id`), KEY `user_id` (`user_id`), KEY `idx_status_date` (`payment_status`,`payment_date`), KEY `idx_user_status` (`user_id`,`payment_status`), KEY `idx_course_status` (`course_id`,`payment_status`), CONSTRAINT `payments_ibfk_3` FOREIGN KEY (`course_id`) REFERENCES `courses` (`id`) ON DELETE CASCADE, CONSTRAINT `payments_ibfk_4` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `payment_details`
DROP TABLE IF EXISTS `payment_details`;
CREATE TABLE `payment_details` ( `id` int(11) NOT NULL AUTO_INCREMENT, `payment_id` int(11) NOT NULL, `course_id` int(11) NOT NULL, `course_name` varchar(255) NOT NULL, PRIMARY KEY (`id`), KEY `payment_id` (`payment_id`), KEY `course_id` (`course_id`), CONSTRAINT `payment_details_ibfk_1` FOREIGN KEY (`payment_id`) REFERENCES `payments` (`id`), CONSTRAINT `payment_details_ibfk_2` FOREIGN KEY (`course_id`) REFERENCES `courses` (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `payment_sessions`
DROP TABLE IF EXISTS `payment_sessions`;
CREATE TABLE `payment_sessions` ( `id` int(11) NOT NULL AUTO_INCREMENT, `checkout_session_id` varchar(255) NOT NULL, `user_id` int(11) NOT NULL, `course_id` int(11) NOT NULL, `amount` decimal(10,2) NOT NULL, `status` enum('pending','completed','failed') NOT NULL DEFAULT 'pending', `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `completed_at` timestamp NULL DEFAULT NULL, `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), KEY `user_id` (`user_id`), KEY `course_id` (`course_id`), CONSTRAINT `payment_sessions_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`), CONSTRAINT `payment_sessions_ibfk_2` FOREIGN KEY (`course_id`) REFERENCES `courses` (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `permissions`
DROP TABLE IF EXISTS `permissions`;
CREATE TABLE `permissions` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(100) NOT NULL, `description` text DEFAULT NULL, `category` varchar(50) NOT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `name` (`name`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_difficulty_modules`
DROP TABLE IF EXISTS `placement_difficulty_modules`;
CREATE TABLE `placement_difficulty_modules` ( `id` int(11) NOT NULL AUTO_INCREMENT, `difficulty_level` enum('beginner','intermediate','advanced') NOT NULL, `course_id` int(11) NOT NULL, `is_primary_recommendation` tinyint(1) DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `course_id` (`course_id`), KEY `idx_difficulty` (`difficulty_level`), CONSTRAINT `placement_difficulty_modules_ibfk_1` FOREIGN KEY (`course_id`) REFERENCES `courses` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_page_questions`
DROP TABLE IF EXISTS `placement_page_questions`;
CREATE TABLE `placement_page_questions` ( `id` int(11) NOT NULL AUTO_INCREMENT, `page_id` int(11) NOT NULL, `question_id` int(11) NOT NULL, `order_index` int(11) NOT NULL DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_page_question` (`page_id`,`question_id`), KEY `question_id` (`question_id`), KEY `idx_page_order` (`page_id`,`order_index`), CONSTRAINT `placement_page_questions_ibfk_1` FOREIGN KEY (`page_id`) REFERENCES `placement_test_pages` (`id`) ON DELETE CASCADE, CONSTRAINT `placement_page_questions_ibfk_2` FOREIGN KEY (`question_id`) REFERENCES `placement_questions` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_questions`
DROP TABLE IF EXISTS `placement_questions`;
CREATE TABLE `placement_questions` ( `id` int(11) NOT NULL AUTO_INCREMENT, `test_id` int(11) NOT NULL, `question_text` text NOT NULL, `question_type` enum('multiple_choice','true_false','fill_blank','short_answer') DEFAULT 'multiple_choice', `difficulty_level` enum('beginner','intermediate','advanced') NOT NULL, `points` int(11) DEFAULT 1, `explanation` text DEFAULT NULL, `image_path` varchar(255) DEFAULT NULL, `audio_path` varchar(255) DEFAULT NULL, `order_index` int(11) DEFAULT 0, `is_active` tinyint(1) DEFAULT 1, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), KEY `test_id` (`test_id`), KEY `idx_difficulty` (`difficulty_level`), KEY `idx_active` (`is_active`), KEY `idx_placement_questions_difficulty` (`difficulty_level`,`is_active`), CONSTRAINT `placement_questions_ibfk_1` FOREIGN KEY (`test_id`) REFERENCES `placement_tests` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_question_choices`
DROP TABLE IF EXISTS `placement_question_choices`;
CREATE TABLE `placement_question_choices` ( `id` int(11) NOT NULL AUTO_INCREMENT, `question_id` int(11) NOT NULL, `choice_text` text NOT NULL, `is_correct` tinyint(1) DEFAULT 0, `order_index` int(11) DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `question_id` (`question_id`), CONSTRAINT `placement_question_choices_ibfk_1` FOREIGN KEY (`question_id`) REFERENCES `placement_questions` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_tests`
DROP TABLE IF EXISTS `placement_tests`;
CREATE TABLE `placement_tests` ( `id` int(11) NOT NULL AUTO_INCREMENT, `title` varchar(255) NOT NULL DEFAULT 'Japanese Language Placement Test', `description` text DEFAULT NULL, `instructions` text DEFAULT NULL, `max_questions` int(11) DEFAULT 20, `time_limit_minutes` int(11) DEFAULT 60, `is_active` tinyint(1) DEFAULT 1, `is_published` tinyint(1) DEFAULT 0, `passing_score` decimal(5,2) DEFAULT 70.00, `created_by` int(11) NOT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), KEY `created_by` (`created_by`), CONSTRAINT `placement_tests_ibfk_1` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_test_answers`
DROP TABLE IF EXISTS `placement_test_answers`;
CREATE TABLE `placement_test_answers` ( `id` int(11) NOT NULL AUTO_INCREMENT, `session_id` int(11) NOT NULL, `question_id` int(11) NOT NULL, `choice_id` int(11) DEFAULT NULL, `answer_text` text DEFAULT NULL, `is_correct` tinyint(1) DEFAULT 0, `points_earned` decimal(5,2) DEFAULT 0.00, `time_spent_seconds` int(11) DEFAULT 0, `answered_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_session_question` (`session_id`,`question_id`), KEY `question_id` (`question_id`), KEY `choice_id` (`choice_id`), CONSTRAINT `placement_test_answers_ibfk_1` FOREIGN KEY (`session_id`) REFERENCES `placement_test_sessions` (`id`) ON DELETE CASCADE, CONSTRAINT `placement_test_answers_ibfk_2` FOREIGN KEY (`question_id`) REFERENCES `placement_questions` (`id`) ON DELETE CASCADE, CONSTRAINT `placement_test_answers_ibfk_3` FOREIGN KEY (`choice_id`) REFERENCES `placement_question_choices` (`id`) ON DELETE SET NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_test_design`
DROP TABLE IF EXISTS `placement_test_design`;
CREATE TABLE `placement_test_design` ( `id` int(11) NOT NULL AUTO_INCREMENT, `test_id` int(11) NOT NULL, `logo_image` varchar(255) DEFAULT NULL, `header_title` varchar(255) DEFAULT 'Placement Test', `header_color` varchar(7) DEFAULT '#1f2937', `header_text_color` varchar(7) DEFAULT '#ffffff', `header_type` enum('solid','gradient') DEFAULT 'solid', `header_gradient` varchar(100) DEFAULT NULL, `background_color` varchar(7) DEFAULT '#f5f5f5', `background_type` enum('solid','gradient') DEFAULT 'solid', `background_gradient` varchar(100) DEFAULT NULL, `page_background_color` varchar(7) DEFAULT '#f3f4f6', `accent_color` varchar(7) DEFAULT '#dc2626', `font_family` varchar(50) DEFAULT 'Inter', `footer_color` varchar(7) DEFAULT '#1f2937', `footer_text_color` varchar(7) DEFAULT '#ffffff', `button_color` varchar(7) DEFAULT '#dc2626', `button_position` enum('bottom-fixed','bottom-card','inline') DEFAULT 'bottom-fixed', `custom_css` text DEFAULT NULL, `welcome_content` text DEFAULT NULL, `welcome_image` varchar(255) DEFAULT NULL, `instructions_content` text DEFAULT NULL, `completion_content` text DEFAULT NULL, `is_published` tinyint(1) DEFAULT 0, `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_test_design` (`test_id`), CONSTRAINT `placement_test_design_ibfk_1` FOREIGN KEY (`test_id`) REFERENCES `placement_tests` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_test_images`
DROP TABLE IF EXISTS `placement_test_images`;
CREATE TABLE `placement_test_images` ( `id` int(11) NOT NULL AUTO_INCREMENT, `page_key` varchar(100) NOT NULL, `filename` varchar(255) NOT NULL, `original_name` varchar(255) NOT NULL, `file_size` int(11) NOT NULL, `mime_type` varchar(100) NOT NULL, `uploaded_by` int(11) NOT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `idx_page_key` (`page_key`), KEY `idx_uploaded_by` (`uploaded_by`), CONSTRAINT `placement_test_images_ibfk_1` FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_test_pages`
DROP TABLE IF EXISTS `placement_test_pages`;
CREATE TABLE `placement_test_pages` ( `id` int(11) NOT NULL AUTO_INCREMENT, `test_id` int(11) NOT NULL, `page_type` enum('welcome','instructions','questions','completion','custom') NOT NULL, `page_key` varchar(100) NOT NULL, `title` varchar(255) NOT NULL, `content` text DEFAULT NULL, `image_path` varchar(255) DEFAULT NULL, `page_order` int(11) NOT NULL DEFAULT 0, `question_count` int(11) DEFAULT 0, `is_required` tinyint(1) DEFAULT 1, `is_active` tinyint(1) DEFAULT 1, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_test_page_key` (`test_id`,`page_key`), KEY `idx_test_order` (`test_id`,`page_order`), KEY `idx_page_type` (`page_type`), CONSTRAINT `placement_test_pages_ibfk_1` FOREIGN KEY (`test_id`) REFERENCES `placement_tests` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_test_results`
DROP TABLE IF EXISTS `placement_test_results`;
CREATE TABLE `placement_test_results` ( `id` int(11) NOT NULL AUTO_INCREMENT, `session_id` int(11) NOT NULL, `student_id` int(11) NOT NULL, `test_id` int(11) NOT NULL, `total_questions` int(11) NOT NULL, `correct_answers` int(11) NOT NULL, `total_points` decimal(8,2) NOT NULL, `max_possible_points` decimal(8,2) NOT NULL, `percentage_score` decimal(5,2) NOT NULL, `difficulty_breakdown` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`difficulty_breakdown`)), `recommended_level` enum('beginner','intermediate','advanced') DEFAULT NULL, `recommended_course_id` int(11) DEFAULT NULL, `completion_time_seconds` int(11) DEFAULT NULL, `detailed_feedback` text DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `beginner_score` int(11) DEFAULT 0, `intermediate_score` int(11) DEFAULT 0, `advanced_score` int(11) DEFAULT 0, `beginner_total` int(11) DEFAULT 0, `intermediate_total` int(11) DEFAULT 0, `advanced_total` int(11) DEFAULT 0, `recommended_module_start` int(11) DEFAULT NULL, `recommended_module_end` int(11) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `unique_student_result` (`student_id`,`test_id`), KEY `session_id` (`session_id`), KEY `test_id` (`test_id`), KEY `recommended_course_id` (`recommended_course_id`), KEY `idx_score` (`percentage_score`), KEY `idx_level` (`recommended_level`), KEY `idx_placement_results_score` (`percentage_score`), KEY `idx_placement_results_level` (`recommended_level`), KEY `idx_placement_results_student_test` (`student_id`,`test_id`), KEY `idx_placement_results_recommended_level` (`recommended_level`), CONSTRAINT `placement_test_results_ibfk_1` FOREIGN KEY (`session_id`) REFERENCES `placement_test_sessions` (`id`) ON DELETE CASCADE, CONSTRAINT `placement_test_results_ibfk_2` FOREIGN KEY (`student_id`) REFERENCES `users` (`id`) ON DELETE CASCADE, CONSTRAINT `placement_test_results_ibfk_3` FOREIGN KEY (`test_id`) REFERENCES `placement_tests` (`id`) ON DELETE CASCADE, CONSTRAINT `placement_test_results_ibfk_4` FOREIGN KEY (`recommended_course_id`) REFERENCES `courses` (`id`) ON DELETE SET NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `placement_test_sessions`
DROP TABLE IF EXISTS `placement_test_sessions`;
CREATE TABLE `placement_test_sessions` ( `id` int(11) NOT NULL AUTO_INCREMENT, `student_id` int(11) NOT NULL, `test_id` int(11) NOT NULL, `session_token` varchar(64) NOT NULL, `status` enum('started','in_progress','completed','abandoned') DEFAULT 'started', `start_time` timestamp NOT NULL DEFAULT current_timestamp(), `end_time` timestamp NULL DEFAULT NULL, `total_questions` int(11) DEFAULT 0, `answered_questions` int(11) DEFAULT 0, `current_question_index` int(11) DEFAULT 0, `time_remaining_seconds` int(11) DEFAULT NULL, `ip_address` varchar(45) DEFAULT NULL, `user_agent` text DEFAULT NULL, `completion_time` int(11) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `session_token` (`session_token`), UNIQUE KEY `unique_student_test` (`student_id`,`test_id`), KEY `test_id` (`test_id`), KEY `idx_status` (`status`), KEY `idx_student` (`student_id`), KEY `idx_placement_sessions_student_status` (`student_id`,`status`), KEY `idx_placement_sessions_status` (`status`), CONSTRAINT `placement_test_sessions_ibfk_1` FOREIGN KEY (`student_id`) REFERENCES `users` (`id`) ON DELETE CASCADE, CONSTRAINT `placement_test_sessions_ibfk_2` FOREIGN KEY (`test_id`) REFERENCES `placement_tests` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `progress`
DROP TABLE IF EXISTS `progress`;
CREATE TABLE `progress` ( `id` int(11) NOT NULL AUTO_INCREMENT, `student_id` int(11) NOT NULL, `section_id` int(11) NOT NULL, `completed` tinyint(1) DEFAULT 0, `completed_at` timestamp NULL DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_progress` (`student_id`,`section_id`), KEY `section_id` (`section_id`), CONSTRAINT `progress_ibfk_1` FOREIGN KEY (`student_id`) REFERENCES `users` (`id`) ON DELETE CASCADE, CONSTRAINT `progress_ibfk_2` FOREIGN KEY (`section_id`) REFERENCES `sections` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `quizzes`
DROP TABLE IF EXISTS `quizzes`;
CREATE TABLE `quizzes` ( `id` int(11) NOT NULL AUTO_INCREMENT, `section_id` int(11) NOT NULL, `title` varchar(255) NOT NULL, `description` text DEFAULT NULL, `passing_score` int(11) NOT NULL DEFAULT 70, `order_index` int(11) NOT NULL DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), `time_limit` int(11) DEFAULT NULL, `total_points` int(11) DEFAULT 0, PRIMARY KEY (`id`), KEY `idx_quizzes_section` (`section_id`), CONSTRAINT `quizzes_ibfk_1` FOREIGN KEY (`section_id`) REFERENCES `sections` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `quiz_answers`
DROP TABLE IF EXISTS `quiz_answers`;
CREATE TABLE `quiz_answers` ( `id` int(11) NOT NULL AUTO_INCREMENT, `attempt_id` int(11) NOT NULL, `question_id` int(11) NOT NULL, `answer_text` text NOT NULL, `is_correct` tinyint(1) NOT NULL DEFAULT 0, `points_earned` int(11) NOT NULL DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), KEY `attempt_id` (`attempt_id`), KEY `question_id` (`question_id`), CONSTRAINT `quiz_answers_ibfk_1` FOREIGN KEY (`attempt_id`) REFERENCES `quiz_attempts` (`id`) ON DELETE CASCADE, CONSTRAINT `quiz_answers_ibfk_2` FOREIGN KEY (`question_id`) REFERENCES `quiz_questions` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `quiz_attempts`
DROP TABLE IF EXISTS `quiz_attempts`;
CREATE TABLE `quiz_attempts` ( `id` int(11) NOT NULL AUTO_INCREMENT, `quiz_id` int(11) NOT NULL, `student_id` int(11) NOT NULL, `score` int(11) NOT NULL DEFAULT 0, `total_points` int(11) NOT NULL DEFAULT 0, `completed_at` timestamp NOT NULL DEFAULT current_timestamp(), `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), KEY `quiz_id` (`quiz_id`), KEY `student_id` (`student_id`), CONSTRAINT `quiz_attempts_ibfk_1` FOREIGN KEY (`quiz_id`) REFERENCES `quizzes` (`id`) ON DELETE CASCADE, CONSTRAINT `quiz_attempts_ibfk_2` FOREIGN KEY (`student_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `quiz_choices`
DROP TABLE IF EXISTS `quiz_choices`;
CREATE TABLE `quiz_choices` ( `id` int(11) NOT NULL AUTO_INCREMENT, `question_id` int(11) NOT NULL, `choice_text` text NOT NULL, `is_correct` tinyint(1) NOT NULL DEFAULT 0, `order_index` int(11) NOT NULL DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), KEY `idx_choices_question` (`question_id`), CONSTRAINT `quiz_choices_ibfk_1` FOREIGN KEY (`question_id`) REFERENCES `quiz_questions` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `quiz_questions`
DROP TABLE IF EXISTS `quiz_questions`;
CREATE TABLE `quiz_questions` ( `id` int(11) NOT NULL AUTO_INCREMENT, `quiz_id` int(11) NOT NULL, `question_text` text NOT NULL, `question_type` enum('multiple_choice','true_false') NOT NULL DEFAULT 'multiple_choice', `order_index` int(11) NOT NULL DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), `quiz_type` enum('multiple_choice','true_false','fill_in_blanks','short_answer','matching_type') NOT NULL DEFAULT 'multiple_choice', `score` int(11) NOT NULL DEFAULT 1, `question` text NOT NULL, `type` varchar(50) DEFAULT 'multiple_choice', `points` int(11) DEFAULT 1, PRIMARY KEY (`id`), KEY `idx_questions_quiz` (`quiz_id`), CONSTRAINT `quiz_questions_ibfk_1` FOREIGN KEY (`quiz_id`) REFERENCES `quizzes` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `role_templates`
DROP TABLE IF EXISTS `role_templates`;
CREATE TABLE `role_templates` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(100) NOT NULL, `description` text DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `name` (`name`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `role_template_permissions`
DROP TABLE IF EXISTS `role_template_permissions`;
CREATE TABLE `role_template_permissions` ( `template_id` int(11) NOT NULL, `permission_id` int(11) NOT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`template_id`,`permission_id`), KEY `permission_id` (`permission_id`), CONSTRAINT `role_template_permissions_ibfk_1` FOREIGN KEY (`template_id`) REFERENCES `role_templates` (`id`) ON DELETE CASCADE, CONSTRAINT `role_template_permissions_ibfk_2` FOREIGN KEY (`permission_id`) REFERENCES `permissions` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `sections`
DROP TABLE IF EXISTS `sections`;
CREATE TABLE `sections` ( `id` int(11) NOT NULL AUTO_INCREMENT, `course_id` int(11) NOT NULL DEFAULT 1, `title` varchar(255) NOT NULL, `description` text DEFAULT NULL, `content` text DEFAULT NULL, `order_index` int(11) NOT NULL DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), KEY `fk_sections_course_id` (`course_id`), CONSTRAINT `fk_sections_course_id` FOREIGN KEY (`course_id`) REFERENCES `courses` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `system_error_log`
DROP TABLE IF EXISTS `system_error_log`;
CREATE TABLE `system_error_log` ( `id` int(11) NOT NULL AUTO_INCREMENT, `error_type` varchar(100) NOT NULL, `module_name` varchar(255) DEFAULT NULL, `category` enum('ai_failure','response_time','backend_error','system_error') NOT NULL DEFAULT 'system_error', `error_level` enum('notice','warning','error','fatal') NOT NULL DEFAULT 'error', `severity` enum('info','warning','critical') NOT NULL DEFAULT 'warning', `error_message` text NOT NULL, `user_query` text DEFAULT NULL COMMENT 'Original user query for AI failures', `ai_response` text DEFAULT NULL COMMENT 'AI response (if any)', `error_file` varchar(500) DEFAULT NULL, `error_line` int(11) DEFAULT NULL, `stack_trace` longtext DEFAULT NULL, `root_cause` varchar(255) DEFAULT NULL, `user_id` int(11) DEFAULT NULL, `session_id` varchar(128) DEFAULT NULL, `ip_address` varchar(45) DEFAULT NULL, `user_agent` text DEFAULT NULL, `device_type` varchar(50) DEFAULT NULL, `browser_name` varchar(100) DEFAULT NULL, `operating_system` varchar(100) DEFAULT NULL, `status` enum('failed','retried','resolved','logged') NOT NULL DEFAULT 'logged', `retry_count` int(11) DEFAULT 0, `alert_sent` tinyint(1) DEFAULT 0, `request_url` text DEFAULT NULL, `endpoint` varchar(500) DEFAULT NULL, `response_time_ms` int(11) DEFAULT NULL COMMENT 'Response time in milliseconds', `expected_response_time_ms` int(11) DEFAULT NULL COMMENT 'Expected response time in milliseconds', `request_method` varchar(10) DEFAULT NULL, `post_data` longtext DEFAULT NULL, `server_vars` longtext DEFAULT NULL, `occurred_at` datetime NOT NULL, `resolved_at` datetime DEFAULT NULL, `resolved_by` int(11) DEFAULT NULL, `resolution_notes` text DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `idx_error_type` (`error_type`), KEY `idx_error_level` (`error_level`), KEY `idx_occurred_at` (`occurred_at`), KEY `idx_user_id` (`user_id`), KEY `resolved_by` (`resolved_by`), KEY `idx_category` (`category`), KEY `idx_severity` (`severity`), KEY `idx_module_name` (`module_name`), KEY `idx_status` (`status`), KEY `idx_response_time` (`response_time_ms`), KEY `idx_category_severity` (`category`,`severity`), KEY `idx_occurred_status` (`occurred_at`,`status`), CONSTRAINT `system_error_log_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL, CONSTRAINT `system_error_log_ibfk_2` FOREIGN KEY (`resolved_by`) REFERENCES `users` (`id`) ON DELETE SET NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `system_health_metrics`
DROP TABLE IF EXISTS `system_health_metrics`;
CREATE TABLE `system_health_metrics` ( `id` int(11) NOT NULL AUTO_INCREMENT, `metric_type` enum('cpu','memory','disk','database','response_time') NOT NULL, `metric_value` decimal(10,2) NOT NULL, `metric_unit` varchar(20) NOT NULL, `threshold_warning` decimal(10,2) DEFAULT NULL, `threshold_critical` decimal(10,2) DEFAULT NULL, `status` enum('healthy','warning','critical') NOT NULL DEFAULT 'healthy', `server_name` varchar(100) DEFAULT 'main', `recorded_at` datetime NOT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `idx_metric_type` (`metric_type`), KEY `idx_recorded_at` (`recorded_at`), KEY `idx_status` (`status`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `system_notifications`
DROP TABLE IF EXISTS `system_notifications`;
CREATE TABLE `system_notifications` ( `id` int(11) NOT NULL AUTO_INCREMENT, `title` varchar(255) NOT NULL, `message` text NOT NULL, `type` enum('info','warning','error','success') DEFAULT 'info', `target_admin_id` int(11) DEFAULT NULL, `is_read` tinyint(1) DEFAULT 0, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `expires_at` timestamp NULL DEFAULT NULL, PRIMARY KEY (`id`), KEY `idx_target_admin` (`target_admin_id`), KEY `idx_created_at` (`created_at`), KEY `idx_is_read` (`is_read`), CONSTRAINT `system_notifications_ibfk_1` FOREIGN KEY (`target_admin_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `system_uptime_log`
DROP TABLE IF EXISTS `system_uptime_log`;
CREATE TABLE `system_uptime_log` ( `id` int(11) NOT NULL AUTO_INCREMENT, `event_type` enum('uptime','downtime') NOT NULL DEFAULT 'uptime', `start_time` datetime NOT NULL, `end_time` datetime DEFAULT NULL, `duration_seconds` int(11) DEFAULT NULL, `status` enum('active','completed') NOT NULL DEFAULT 'active', `error_message` text DEFAULT NULL, `root_cause` varchar(255) DEFAULT NULL, `severity` enum('low','medium','high','critical') DEFAULT 'medium', `server_ip` varchar(45) DEFAULT NULL, `monitored_by` varchar(100) DEFAULT 'system', `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), KEY `idx_event_type` (`event_type`), KEY `idx_start_time` (`start_time`), KEY `idx_status` (`status`), KEY `idx_severity` (`severity`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `teacher_preferences`
DROP TABLE IF EXISTS `teacher_preferences`;
CREATE TABLE `teacher_preferences` ( `id` int(11) NOT NULL AUTO_INCREMENT, `teacher_id` int(11) NOT NULL, `first_name` varchar(100) DEFAULT NULL, `last_name` varchar(100) DEFAULT NULL, `display_name` varchar(100) DEFAULT NULL, `bio` text DEFAULT NULL, `phone` varchar(20) DEFAULT NULL, `languages` varchar(255) DEFAULT NULL, `notification_settings` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`notification_settings`)), `teaching_preferences` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`teaching_preferences`)), `dashboard_preferences` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`dashboard_preferences`)), `profile_visible` tinyint(1) DEFAULT 1, `contact_visible` tinyint(1) DEFAULT 1, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_teacher` (`teacher_id`), CONSTRAINT `teacher_preferences_ibfk_1` FOREIGN KEY (`teacher_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `teacher_question_types`
DROP TABLE IF EXISTS `teacher_question_types`;
CREATE TABLE `teacher_question_types` ( `id` int(11) NOT NULL AUTO_INCREMENT, `teacher_id` int(11) DEFAULT NULL, `question_type_id` varchar(50) DEFAULT NULL, `is_active` tinyint(1) DEFAULT 1, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Table structure for table `temp_checkout_mapping`
DROP TABLE IF EXISTS `temp_checkout_mapping`;
CREATE TABLE `temp_checkout_mapping` ( `id` int(11) NOT NULL AUTO_INCREMENT, `temp_id` varchar(255) NOT NULL, `checkout_session_id` varchar(255) DEFAULT NULL, `user_id` int(11) NOT NULL, `course_id` int(11) NOT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `temp_id` (`temp_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Table structure for table `terms_conditions`
DROP TABLE IF EXISTS `terms_conditions`;
CREATE TABLE `terms_conditions` ( `id` int(11) NOT NULL AUTO_INCREMENT, `content` text NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `text_progress`
DROP TABLE IF EXISTS `text_progress`;
CREATE TABLE `text_progress` ( `id` int(11) NOT NULL AUTO_INCREMENT, `student_id` int(11) NOT NULL, `chapter_id` int(11) NOT NULL, `section_id` int(11) NOT NULL, `course_id` int(11) NOT NULL, `completed` tinyint(1) DEFAULT 0, `completed_at` timestamp NULL DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_text_progress` (`student_id`,`chapter_id`), KEY `chapter_id` (`chapter_id`), KEY `section_id` (`section_id`), KEY `course_id` (`course_id`), CONSTRAINT `text_progress_ibfk_1` FOREIGN KEY (`student_id`) REFERENCES `users` (`id`), CONSTRAINT `text_progress_ibfk_2` FOREIGN KEY (`chapter_id`) REFERENCES `chapters` (`id`), CONSTRAINT `text_progress_ibfk_3` FOREIGN KEY (`section_id`) REFERENCES `sections` (`id`), CONSTRAINT `text_progress_ibfk_4` FOREIGN KEY (`course_id`) REFERENCES `courses` (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Table structure for table `uptime_statistics`
DROP TABLE IF EXISTS `uptime_statistics`;
CREATE TABLE `uptime_statistics` ( `id` int(11) NOT NULL AUTO_INCREMENT, `date` date NOT NULL, `uptime_seconds` int(11) DEFAULT 0, `downtime_seconds` int(11) DEFAULT 0, `downtime_incidents` int(11) DEFAULT 0, `uptime_percentage` decimal(5,2) DEFAULT 0.00, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_date` (`date`), KEY `idx_date` (`date`), KEY `idx_uptime_percentage` (`uptime_percentage`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `users`
DROP TABLE IF EXISTS `users`;
CREATE TABLE `users` ( `id` int(11) NOT NULL AUTO_INCREMENT, `username` varchar(50) NOT NULL, `email` varchar(100) NOT NULL, `phone_number` varchar(20) DEFAULT NULL, `password` varchar(255) NOT NULL, `role` enum('admin','teacher','student') NOT NULL DEFAULT 'student', `status` enum('active','inactive','pending','locked','suspended','banned','password_reset','deleted') NOT NULL DEFAULT 'active', `is_first_login` tinyint(1) NOT NULL DEFAULT 1, `first_name` varchar(50) DEFAULT NULL, `middle_name` varchar(100) DEFAULT NULL, `suffix` varchar(10) DEFAULT NULL, `location` varchar(100) DEFAULT NULL, `age` int(11) DEFAULT NULL, `last_name` varchar(100) DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), `deleted_at` timestamp NULL DEFAULT NULL, `last_login_at` timestamp NULL DEFAULT NULL, `login_attempts` int(11) NOT NULL DEFAULT 0, `reset_token` varchar(64) DEFAULT NULL, `reset_token_expiry` datetime DEFAULT NULL, `email_verified` tinyint(1) DEFAULT 0, `login_time` datetime DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `username` (`username`), UNIQUE KEY `email` (`email`), KEY `idx_users_role` (`role`), KEY `idx_role_login` (`role`,`last_login_at`), KEY `idx_status_updated` (`status`,`updated_at`), KEY `idx_created_at` (`created_at`), KEY `idx_users_status` (`status`), KEY `idx_users_deleted_at` (`deleted_at`), KEY `idx_phone_number` (`phone_number`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `user_activity_log`
DROP TABLE IF EXISTS `user_activity_log`;
CREATE TABLE `user_activity_log` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) NOT NULL, `username` varchar(255) NOT NULL, `activity_type` varchar(100) NOT NULL, `resource_type` varchar(100) DEFAULT NULL, `resource_id` varchar(255) DEFAULT NULL, `ip_address` varchar(45) NOT NULL, `user_agent` text DEFAULT NULL, `device_type` enum('Desktop','Mobile','Tablet') DEFAULT NULL, `browser_name` varchar(100) DEFAULT NULL, `operating_system` varchar(100) DEFAULT NULL, `session_id` varchar(255) DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `additional_data` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`additional_data`)), PRIMARY KEY (`id`), KEY `idx_user_id` (`user_id`), KEY `idx_created_at` (`created_at`), KEY `idx_activity_type` (`activity_type`), KEY `idx_resource_type` (`resource_type`), CONSTRAINT `user_activity_log_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `user_permissions`
DROP TABLE IF EXISTS `user_permissions`;
CREATE TABLE `user_permissions` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) NOT NULL, `permission_name` varchar(100) NOT NULL, `template_id` int(11) DEFAULT NULL, `granted_by` int(11) DEFAULT NULL, `granted_at` timestamp NOT NULL DEFAULT current_timestamp(), `created_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_user_permission` (`user_id`,`permission_name`), KEY `template_id` (`template_id`), KEY `granted_by` (`granted_by`), KEY `idx_user_permissions_user_id` (`user_id`), KEY `idx_user_permissions_name` (`permission_name`), CONSTRAINT `user_permissions_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE, CONSTRAINT `user_permissions_ibfk_2` FOREIGN KEY (`template_id`) REFERENCES `role_templates` (`id`) ON DELETE SET NULL, CONSTRAINT `user_permissions_ibfk_3` FOREIGN KEY (`granted_by`) REFERENCES `users` (`id`) ON DELETE SET NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `user_permissions_view`
DROP TABLE IF EXISTS `user_permissions_view`;
CREATE TABLE `user_permissions_view` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_id` int(11) NOT NULL, `username` varchar(255) NOT NULL, `role` enum('admin','teacher','student') NOT NULL, `permission_name` varchar(100) NOT NULL, `permission_source` enum('custom','template') NOT NULL, `template_name` varchar(100) DEFAULT NULL, `granted_by` int(11) DEFAULT NULL, `granted_at` timestamp NULL DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), KEY `idx_user_id` (`user_id`), KEY `idx_username` (`username`), KEY `idx_role` (`role`), KEY `idx_permission_name` (`permission_name`), KEY `idx_permission_source` (`permission_source`), KEY `idx_template_name` (`template_name`), KEY `granted_by` (`granted_by`), CONSTRAINT `user_permissions_view_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE, CONSTRAINT `user_permissions_view_ibfk_2` FOREIGN KEY (`granted_by`) REFERENCES `users` (`id`) ON DELETE SET NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `user_roles`
DROP TABLE IF EXISTS `user_roles`;
CREATE TABLE `user_roles` ( `user_id` int(11) NOT NULL, `template_id` int(11) NOT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `granted_by` int(11) DEFAULT NULL, `granted_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`user_id`,`template_id`), KEY `idx_user_roles_user_id` (`user_id`), KEY `idx_user_roles_template_id` (`template_id`), CONSTRAINT `user_roles_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE, CONSTRAINT `user_roles_ibfk_2` FOREIGN KEY (`template_id`) REFERENCES `role_templates` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table structure for table `video_progress`
DROP TABLE IF EXISTS `video_progress`;
CREATE TABLE `video_progress` ( `id` int(11) NOT NULL AUTO_INCREMENT, `student_id` int(11) NOT NULL, `chapter_id` int(11) NOT NULL, `section_id` int(11) NOT NULL, `course_id` int(11) NOT NULL, `completed` tinyint(1) DEFAULT 0, `completion_percentage` decimal(5,2) DEFAULT 0.00, `watch_time_seconds` int(11) DEFAULT 0, `total_duration_seconds` int(11) DEFAULT 0, `completed_at` timestamp NULL DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp(), `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), PRIMARY KEY (`id`), UNIQUE KEY `unique_video_progress` (`student_id`,`chapter_id`), KEY `chapter_id` (`chapter_id`), KEY `section_id` (`section_id`), KEY `course_id` (`course_id`), CONSTRAINT `video_progress_ibfk_1` FOREIGN KEY (`student_id`) REFERENCES `users` (`id`), CONSTRAINT `video_progress_ibfk_2` FOREIGN KEY (`chapter_id`) REFERENCES `chapters` (`id`), CONSTRAINT `video_progress_ibfk_3` FOREIGN KEY (`section_id`) REFERENCES `sections` (`id`), CONSTRAINT `video_progress_ibfk_4` FOREIGN KEY (`course_id`) REFERENCES `courses` (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Table structure for table `v_user_activity_analytics`
DROP TABLE IF EXISTS `v_user_activity_analytics`;
CREATE TABLE `v_user_activity_analytics` ( `id` int(11) NOT NULL AUTO_INCREMENT, `user_activity_log_id` int(11) NOT NULL, `user_id` int(11) NOT NULL, `username` varchar(255) NOT NULL, `email` varchar(255) NOT NULL, `role` enum('admin','teacher','student') NOT NULL, `action` varchar(255) NOT NULL, `description` text DEFAULT NULL, `ip_address` varchar(45) DEFAULT NULL, `user_agent` text DEFAULT NULL, `created_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(), `activity_date` date NOT NULL, `activity_year` int(11) NOT NULL, `activity_month` int(11) NOT NULL, `activity_week` int(11) NOT NULL, `activity_day_of_week` int(11) NOT NULL, `activity_hour` int(11) NOT NULL, `processed_at` timestamp NOT NULL DEFAULT current_timestamp(), PRIMARY KEY (`id`), KEY `idx_user_id` (`user_id`), KEY `idx_username` (`username`), KEY `idx_role` (`role`), KEY `idx_action` (`action`), KEY `idx_activity_date` (`activity_date`), KEY `idx_activity_year` (`activity_year`), KEY `idx_activity_month` (`activity_month`), KEY `idx_activity_week` (`activity_week`), KEY `idx_activity_day_of_week` (`activity_day_of_week`), KEY `idx_activity_hour` (`activity_hour`), KEY `idx_created_at` (`created_at`), CONSTRAINT `v_user_activity_analytics_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- View structure for view `current_system_status`
DROP VIEW IF EXISTS `current_system_status`;
CREATE VIEW `current_system_status` AS select 'uptime' AS `status_type`,coalesce(timestampdiff(SECOND,(select `system_uptime_log`.`start_time` from `system_uptime_log` where `system_uptime_log`.`event_type` = 'uptime' and `system_uptime_log`.`status` = 'active' order by `system_uptime_log`.`start_time` desc limit 1),current_timestamp()),0) AS `current_duration_seconds`,(select `system_uptime_log`.`start_time` from `system_uptime_log` where `system_uptime_log`.`event_type` = 'uptime' and `system_uptime_log`.`status` = 'active' order by `system_uptime_log`.`start_time` desc limit 1) AS `current_start_time`,(select count(0) from `system_uptime_log` where `system_uptime_log`.`event_type` = 'downtime' and cast(`system_uptime_log`.`start_time` as date) = curdate()) AS `downtime_events_today`;

-- View structure for view `failed_audit_actions`
DROP VIEW IF EXISTS `failed_audit_actions`;
CREATE VIEW `failed_audit_actions` AS select `cat`.`id` AS `id`,`cat`.`timestamp` AS `timestamp`,`cat`.`user_id` AS `user_id`,`cat`.`username` AS `username`,`cat`.`user_role` AS `user_role`,`cat`.`action_type` AS `action_type`,`cat`.`action_description` AS `action_description`,`cat`.`resource_type` AS `resource_type`,`cat`.`resource_id` AS `resource_id`,`cat`.`resource_name` AS `resource_name`,`cat`.`ip_address` AS `ip_address`,`cat`.`outcome` AS `outcome`,`cat`.`old_value` AS `old_value`,`cat`.`new_value` AS `new_value`,`cat`.`old_value_text` AS `old_value_text`,`cat`.`new_value_text` AS `new_value_text`,`cat`.`device_info` AS `device_info`,`cat`.`browser_name` AS `browser_name`,`cat`.`operating_system` AS `operating_system`,`cat`.`device_type` AS `device_type`,`cat`.`location_country` AS `location_country`,`cat`.`location_city` AS `location_city`,`cat`.`location_ip_info` AS `location_ip_info`,`cat`.`session_id` AS `session_id`,`cat`.`request_method` AS `request_method`,`cat`.`request_url` AS `request_url`,`cat`.`request_headers` AS `request_headers`,`cat`.`request_payload` AS `request_payload`,`cat`.`response_code` AS `response_code`,`cat`.`response_time_ms` AS `response_time_ms`,`cat`.`error_message` AS `error_message`,`cat`.`additional_context` AS `additional_context`,`u`.`email` AS `user_email` from (`comprehensive_audit_trail` `cat` join `users` `u` on(`cat`.`user_id` = `u`.`id`)) where `cat`.`outcome` = 'Failed' order by `cat`.`timestamp` desc;

-- View structure for view `recent_error_activities`
DROP VIEW IF EXISTS `recent_error_activities`;
CREATE VIEW `recent_error_activities` AS select `system_error_log`.`id` AS `id`,`system_error_log`.`category` AS `category`,`system_error_log`.`severity` AS `severity`,`system_error_log`.`error_type` AS `error_type`,`system_error_log`.`error_message` AS `error_message`,`system_error_log`.`module_name` AS `module_name`,`system_error_log`.`user_id` AS `user_id`,`system_error_log`.`occurred_at` AS `occurred_at`,`system_error_log`.`status` AS `status`,case when `system_error_log`.`category` = 'ai_failure' then concat('AI Failure: ',coalesce(`system_error_log`.`error_type`,'Unknown')) when `system_error_log`.`category` = 'response_time' then concat('Slow Response: ',coalesce(`system_error_log`.`endpoint`,`system_error_log`.`module_name`,'Unknown')) when `system_error_log`.`category` = 'backend_error' then concat('Backend Error: ',coalesce(`system_error_log`.`module_name`,`system_error_log`.`error_type`,'Unknown')) else concat('System Error: ',coalesce(`system_error_log`.`error_type`,'Unknown')) end AS `activity_message`,case when `system_error_log`.`severity` = 'critical' then 'error' when `system_error_log`.`severity` = 'warning' then 'warning' else 'info' end AS `activity_type` from `system_error_log` where `system_error_log`.`occurred_at` >= current_timestamp() - interval 24 hour order by `system_error_log`.`occurred_at` desc limit 10;

-- Procedure: CleanupOldAuditEntries
DROP PROCEDURE IF EXISTS `CleanupOldAuditEntries`;
DELIMITER ;;
CREATE PROCEDURE `CleanupOldAuditEntries`() BEGIN DECLARE v_retention_days INT DEFAULT 365; -- Get default retention period SELECT MAX(retention_days) INTO v_retention_days FROM audit_config WHERE is_enabled = TRUE; -- Delete old entries DELETE FROM comprehensive_audit_trail WHERE timestamp < DATE_SUB(NOW(), INTERVAL v_retention_days DAY); -- Delete old summary entries DELETE FROM audit_summary WHERE date < DATE_SUB(CURDATE(), INTERVAL v_retention_days DAY); END;;
DELIMITER ;

-- Procedure: LogAIFailure
DROP PROCEDURE IF EXISTS `LogAIFailure`;
DELIMITER ;;
CREATE PROCEDURE `LogAIFailure`( IN p_user_id INT, IN p_user_query TEXT, IN p_error_type VARCHAR(100), IN p_error_message TEXT, IN p_root_cause VARCHAR(255), IN p_ip_address VARCHAR(45), IN p_user_agent TEXT, IN p_device_info TEXT ) BEGIN DECLARE v_device_type VARCHAR(50) DEFAULT NULL; DECLARE v_browser_name VARCHAR(100) DEFAULT NULL; DECLARE v_os VARCHAR(100) DEFAULT NULL; -- Parse device info from user agent (basic parsing) IF p_user_agent LIKE '%Mobile%' OR p_user_agent LIKE '%Android%' OR p_user_agent LIKE '%iPhone%' THEN SET v_device_type = 'Mobile'; ELSEIF p_user_agent LIKE '%Tablet%' OR p_user_agent LIKE '%iPad%' THEN SET v_device_type = 'Tablet'; ELSE SET v_device_type = 'Desktop'; END IF; -- Parse browser name (basic parsing) IF p_user_agent LIKE '%Chrome%' THEN SET v_browser_name = 'Chrome'; ELSEIF p_user_agent LIKE '%Firefox%' THEN SET v_browser_name = 'Firefox'; ELSEIF p_user_agent LIKE '%Safari%' THEN SET v_browser_name = 'Safari'; ELSEIF p_user_agent LIKE '%Edge%' THEN SET v_browser_name = 'Edge'; ELSE SET v_browser_name = 'Other'; END IF; -- Parse OS (basic parsing) IF p_user_agent LIKE '%Windows%' THEN SET v_os = 'Windows'; ELSEIF p_user_agent LIKE '%Mac%' THEN SET v_os = 'macOS'; ELSEIF p_user_agent LIKE '%Linux%' THEN SET v_os = 'Linux'; ELSEIF p_user_agent LIKE '%Android%' THEN SET v_os = 'Android'; ELSEIF p_user_agent LIKE '%iOS%' THEN SET v_os = 'iOS'; ELSE SET v_os = 'Other'; END IF; INSERT INTO `system_error_log` ( category, error_type, severity, error_message, user_query, user_id, ip_address, user_agent, device_type, browser_name, operating_system, root_cause, occurred_at, status ) VALUES ( 'ai_failure', p_error_type, 'critical', p_error_message, p_user_query, p_user_id, p_ip_address, p_user_agent, v_device_type, v_browser_name, v_os, p_root_cause, NOW(), 'failed' ); END;;
DELIMITER ;

-- Procedure: LogAuditEntry
DROP PROCEDURE IF EXISTS `LogAuditEntry`;
DELIMITER ;;
CREATE PROCEDURE `LogAuditEntry`( IN p_user_id INT, IN p_action_type VARCHAR(20), IN p_action_description TEXT, IN p_resource_type VARCHAR(50), IN p_resource_id VARCHAR(255), IN p_resource_name VARCHAR(500), IN p_ip_address VARCHAR(45), IN p_outcome VARCHAR(20), IN p_old_value_text TEXT, IN p_new_value_text TEXT, IN p_user_agent TEXT, IN p_session_id VARCHAR(255), IN p_request_method VARCHAR(10), IN p_request_url TEXT, IN p_additional_context JSON ) BEGIN DECLARE v_username VARCHAR(255); DECLARE v_user_role VARCHAR(20); DECLARE v_browser_name VARCHAR(100); DECLARE v_operating_system VARCHAR(100); DECLARE v_device_type VARCHAR(20); -- Get user info SELECT username, role INTO v_username, v_user_role FROM users WHERE id = p_user_id; -- Parse user agent (simplified) SET v_browser_name = CASE WHEN p_user_agent LIKE '%Chrome%' THEN 'Chrome' WHEN p_user_agent LIKE '%Firefox%' THEN 'Firefox' WHEN p_user_agent LIKE '%Safari%' AND p_user_agent NOT LIKE '%Chrome%' THEN 'Safari' WHEN p_user_agent LIKE '%Edge%' THEN 'Edge' ELSE 'Unknown' END; SET v_operating_system = CASE WHEN p_user_agent LIKE '%Windows NT 10%' THEN 'Windows 10' WHEN p_user_agent LIKE '%Windows NT 6.1%' THEN 'Windows 7' WHEN p_user_agent LIKE '%Mac OS X%' THEN 'macOS' WHEN p_user_agent LIKE '%Android%' THEN 'Android' WHEN p_user_agent LIKE '%iPhone%' THEN 'iOS' WHEN p_user_agent LIKE '%Linux%' THEN 'Linux' ELSE 'Unknown' END; SET v_device_type = CASE WHEN p_user_agent LIKE '%Mobile%' OR p_user_agent LIKE '%iPhone%' THEN 'Mobile' WHEN p_user_agent LIKE '%Tablet%' OR p_user_agent LIKE '%iPad%' THEN 'Tablet' ELSE 'Desktop' END; -- Insert audit entry INSERT INTO comprehensive_audit_trail ( user_id, username, user_role, action_type, action_description, resource_type, resource_id, resource_name, ip_address, outcome, old_value_text, new_value_text, device_info, browser_name, operating_system, device_type, session_id, request_method, request_url, additional_context ) VALUES ( p_user_id, v_username, v_user_role, p_action_type, p_action_description, p_resource_type, p_resource_id, p_resource_name, p_ip_address, p_outcome, p_old_value_text, p_new_value_text, p_user_agent, v_browser_name, v_operating_system, v_device_type, p_session_id, p_request_method, p_request_url, p_additional_context ); -- Update daily summary INSERT INTO audit_summary (date, user_id, total_actions, last_activity) VALUES (CURDATE(), p_user_id, 1, NOW()) ON DUPLICATE KEY UPDATE total_actions = total_actions + 1, last_activity = NOW(), create_actions = create_actions + (p_action_type = 'CREATE'), read_actions = read_actions + (p_action_type = 'READ'), update_actions = update_actions + (p_action_type = 'UPDATE'), delete_actions = delete_actions + (p_action_type = 'DELETE'), failed_actions = failed_actions + (p_outcome = 'Failed'); END;;
DELIMITER ;

-- Procedure: LogBackendError
DROP PROCEDURE IF EXISTS `LogBackendError`;
DELIMITER ;;
CREATE PROCEDURE `LogBackendError`( IN p_module_name VARCHAR(255), IN p_error_type VARCHAR(100), IN p_error_message TEXT, IN p_error_code VARCHAR(20), IN p_stack_trace LONGTEXT, IN p_user_id INT, IN p_ip_address VARCHAR(45), IN p_request_url TEXT, IN p_severity ENUM('info', 'warning', 'critical') ) BEGIN INSERT INTO `system_error_log` ( category, module_name, error_type, severity, error_message, stack_trace, user_id, ip_address, request_url, occurred_at, status ) VALUES ( 'backend_error', p_module_name, p_error_type, p_severity, p_error_message, p_stack_trace, p_user_id, p_ip_address, p_request_url, NOW(), 'logged' ); END;;
DELIMITER ;

-- Procedure: LogPagePerformance
DROP PROCEDURE IF EXISTS `LogPagePerformance`;
DELIMITER ;;
CREATE PROCEDURE `LogPagePerformance`( IN page VARCHAR(255), IN action_desc VARCHAR(255), IN url TEXT, IN duration DECIMAL(8,3), IN user_id_param INT, IN session_id_param VARCHAR(128), IN ip VARCHAR(45), IN user_agent_param TEXT ) BEGIN DECLARE perf_status VARCHAR(20); DECLARE device_info VARCHAR(50); DECLARE browser_info VARCHAR(100); DECLARE os_info VARCHAR(100); -- Determine performance status SET perf_status = CASE WHEN duration <= 3.0 THEN 'fast' WHEN duration <= 10.0 THEN 'slow' ELSE 'timeout' END; -- Parse user agent for device info (basic parsing) SET device_info = CASE WHEN user_agent_param LIKE '%Mobile%' OR user_agent_param LIKE '%Android%' OR user_agent_param LIKE '%iPhone%' THEN 'Mobile' WHEN user_agent_param LIKE '%Tablet%' OR user_agent_param LIKE '%iPad%' THEN 'Tablet' ELSE 'Desktop' END; SET browser_info = CASE WHEN user_agent_param LIKE '%Chrome%' THEN 'Chrome' WHEN user_agent_param LIKE '%Firefox%' THEN 'Firefox' WHEN user_agent_param LIKE '%Safari%' AND user_agent_param NOT LIKE '%Chrome%' THEN 'Safari' WHEN user_agent_param LIKE '%Edge%' THEN 'Edge' ELSE 'Other' END; SET os_info = CASE WHEN user_agent_param LIKE '%Windows%' THEN 'Windows' WHEN user_agent_param LIKE '%Mac OS%' THEN 'macOS' WHEN user_agent_param LIKE '%Linux%' THEN 'Linux' WHEN user_agent_param LIKE '%Android%' THEN 'Android' WHEN user_agent_param LIKE '%iOS%' THEN 'iOS' ELSE 'Other' END; -- Insert performance log INSERT INTO page_performance_log ( page_name, action_name, full_url, start_time, end_time, load_duration, status, user_id, session_id, ip_address, user_agent, device_type, browser, os, response_code ) VALUES ( page, action_desc, url, DATE_SUB(NOW(), INTERVAL duration SECOND), NOW(), duration, perf_status, user_id_param, session_id_param, ip, user_agent_param, device_info, browser_info, os_info, 200 ); END;;
DELIMITER ;

-- Procedure: LogResponseTimeIssue
DROP PROCEDURE IF EXISTS `LogResponseTimeIssue`;
DELIMITER ;;
CREATE PROCEDURE `LogResponseTimeIssue`( IN p_endpoint VARCHAR(500), IN p_response_time_ms INT, IN p_expected_time_ms INT, IN p_user_id INT, IN p_ip_address VARCHAR(45), IN p_user_agent TEXT, IN p_severity ENUM('info', 'warning', 'critical') ) BEGIN DECLARE v_device_type VARCHAR(50) DEFAULT NULL; DECLARE v_browser_name VARCHAR(100) DEFAULT NULL; DECLARE v_os VARCHAR(100) DEFAULT NULL; DECLARE v_error_message TEXT; -- Create error message SET v_error_message = CONCAT('Slow response detected: ', p_endpoint, ' took ', p_response_time_ms, 'ms (expected: ', p_expected_time_ms, 'ms)'); -- Parse device info (reuse logic from above) IF p_user_agent LIKE '%Mobile%' OR p_user_agent LIKE '%Android%' OR p_user_agent LIKE '%iPhone%' THEN SET v_device_type = 'Mobile'; ELSEIF p_user_agent LIKE '%Tablet%' OR p_user_agent LIKE '%iPad%' THEN SET v_device_type = 'Tablet'; ELSE SET v_device_type = 'Desktop'; END IF; IF p_user_agent LIKE '%Chrome%' THEN SET v_browser_name = 'Chrome'; ELSEIF p_user_agent LIKE '%Firefox%' THEN SET v_browser_name = 'Firefox'; ELSEIF p_user_agent LIKE '%Safari%' THEN SET v_browser_name = 'Safari'; ELSEIF p_user_agent LIKE '%Edge%' THEN SET v_browser_name = 'Edge'; ELSE SET v_browser_name = 'Other'; END IF; IF p_user_agent LIKE '%Windows%' THEN SET v_os = 'Windows'; ELSEIF p_user_agent LIKE '%Mac%' THEN SET v_os = 'macOS'; ELSEIF p_user_agent LIKE '%Linux%' THEN SET v_os = 'Linux'; ELSEIF p_user_agent LIKE '%Android%' THEN SET v_os = 'Android'; ELSEIF p_user_agent LIKE '%iOS%' THEN SET v_os = 'iOS'; ELSE SET v_os = 'Other'; END IF; INSERT INTO `system_error_log` ( category, error_type, severity, error_message, endpoint, response_time_ms, expected_response_time_ms, user_id, ip_address, user_agent, device_type, browser_name, operating_system, occurred_at, status ) VALUES ( 'response_time', 'Slow Response', p_severity, v_error_message, p_endpoint, p_response_time_ms, p_expected_time_ms, p_user_id, p_ip_address, p_user_agent, v_device_type, v_browser_name, v_os, NOW(), 'logged' ); END;;
DELIMITER ;

-- Procedure: LogSystemDowntime
DROP PROCEDURE IF EXISTS `LogSystemDowntime`;
DELIMITER ;;
CREATE PROCEDURE `LogSystemDowntime`( IN error_msg TEXT, IN cause_desc VARCHAR(255), IN severity_level ENUM('low', 'medium', 'high', 'critical') ) BEGIN DECLARE last_event_type VARCHAR(20); DECLARE last_event_id INT; -- Get the last event SELECT event_type, id INTO last_event_type, last_event_id FROM system_uptime_log WHERE status = 'active' ORDER BY start_time DESC LIMIT 1; -- If last event was uptime, close it IF last_event_type = 'uptime' THEN UPDATE system_uptime_log SET end_time = NOW(), duration_seconds = TIMESTAMPDIFF(SECOND, start_time, NOW()), status = 'completed' WHERE id = last_event_id; END IF; -- Start new downtime event INSERT INTO system_uptime_log ( event_type, start_time, status, error_message, root_cause, severity, server_ip, monitored_by ) VALUES ( 'downtime', NOW(), 'active', error_msg, cause_desc, severity_level, COALESCE(@server_ip, '127.0.0.1'), COALESCE(@monitored_by, 'auto-system') ); END;;
DELIMITER ;

-- Procedure: LogSystemUptime
DROP PROCEDURE IF EXISTS `LogSystemUptime`;
DELIMITER ;;
CREATE PROCEDURE `LogSystemUptime`() BEGIN DECLARE last_event_type VARCHAR(20); DECLARE last_event_id INT; -- Get the last event SELECT event_type, id INTO last_event_type, last_event_id FROM system_uptime_log WHERE status = 'active' ORDER BY start_time DESC LIMIT 1; -- If last event was downtime, close it IF last_event_type = 'downtime' THEN UPDATE system_uptime_log SET end_time = NOW(), duration_seconds = TIMESTAMPDIFF(SECOND, start_time, NOW()), status = 'completed' WHERE id = last_event_id; END IF; -- Start new uptime event (only if not already active) IF last_event_type != 'uptime' THEN INSERT INTO system_uptime_log (event_type, start_time, status, server_ip, monitored_by) VALUES ('uptime', NOW(), 'active', COALESCE(@server_ip, '127.0.0.1'), COALESCE(@monitored_by, 'auto-system')); END IF; END;;
DELIMITER ;

-- Procedure: RefreshAllAnalyticsTables
DROP PROCEDURE IF EXISTS `RefreshAllAnalyticsTables`;
DELIMITER ;;
CREATE PROCEDURE `RefreshAllAnalyticsTables`() BEGIN CALL RefreshUptimeStatistics(); CALL RefreshUserPermissionsView(); CALL RefreshUserActivityAnalytics(); SELECT 'All analytics tables refreshed successfully' AS status; END;;
DELIMITER ;

-- Procedure: RefreshUptimeStatistics
DROP PROCEDURE IF EXISTS `RefreshUptimeStatistics`;
DELIMITER ;;
CREATE PROCEDURE `RefreshUptimeStatistics`() BEGIN -- Clear existing data TRUNCATE TABLE uptime_statistics; -- Insert fresh data from system_uptime_log INSERT INTO uptime_statistics (date, uptime_seconds, downtime_seconds, downtime_incidents, uptime_percentage) SELECT CAST(start_time AS DATE) AS date, SUM(CASE WHEN event_type = 'uptime' THEN COALESCE(duration_seconds, 0) END) AS uptime_seconds, SUM(CASE WHEN event_type = 'downtime' THEN COALESCE(duration_seconds, 0) END) AS downtime_seconds, COUNT(CASE WHEN event_type = 'downtime' THEN 1 END) AS downtime_incidents, ROUND( SUM(CASE WHEN event_type = 'uptime' THEN COALESCE(duration_seconds, 0) END) * 100.0 / (SUM(CASE WHEN event_type = 'uptime' THEN COALESCE(duration_seconds, 0) END) + SUM(CASE WHEN event_type = 'downtime' THEN COALESCE(duration_seconds, 0) END)), 2 ) AS uptime_percentage FROM system_uptime_log WHERE start_time >= DATE_SUB(NOW(), INTERVAL 30 DAY) GROUP BY CAST(start_time AS DATE) ORDER BY CAST(start_time AS DATE) DESC; SELECT 'Uptime statistics refreshed successfully' AS status; END;;
DELIMITER ;

-- Procedure: RefreshUserActivityAnalytics
DROP PROCEDURE IF EXISTS `RefreshUserActivityAnalytics`;
DELIMITER ;;
CREATE PROCEDURE `RefreshUserActivityAnalytics`() BEGIN -- Clear existing data TRUNCATE TABLE v_user_activity_analytics; -- Insert fresh data from user_activity_log INSERT INTO v_user_activity_analytics ( user_activity_log_id, user_id, username, email, role, action, description, ip_address, user_agent, created_at, activity_date, activity_year, activity_month, activity_week, activity_day_of_week, activity_hour ) SELECT ual.id AS user_activity_log_id, ual.user_id AS user_id, u.username AS username, u.email AS email, u.role AS role, ual.action AS action, ual.description AS description, ual.ip_address AS ip_address, ual.user_agent AS user_agent, ual.created_at AS created_at, CAST(ual.created_at AS DATE) AS activity_date, YEAR(ual.created_at) AS activity_year, MONTH(ual.created_at) AS activity_month, WEEK(ual.created_at, 1) AS activity_week, DAYOFWEEK(ual.created_at) AS activity_day_of_week, HOUR(ual.created_at) AS activity_hour FROM user_activity_log ual JOIN users u ON ual.user_id = u.id ORDER BY ual.created_at DESC; SELECT 'User activity analytics refreshed successfully' AS status; END;;
DELIMITER ;

-- Procedure: RefreshUserPermissionsView
DROP PROCEDURE IF EXISTS `RefreshUserPermissionsView`;
DELIMITER ;;
CREATE PROCEDURE `RefreshUserPermissionsView`() BEGIN -- Clear existing data TRUNCATE TABLE user_permissions_view; -- Insert fresh data from the original view logic INSERT INTO user_permissions_view (user_id, username, role, permission_name, permission_source, template_name, granted_by, granted_at) SELECT DISTINCT u.id AS user_id, u.username AS username, u.role AS role, COALESCE(up.permission_name, p.name) AS permission_name, CASE WHEN up.permission_name IS NOT NULL THEN 'custom' ELSE 'template' END AS permission_source, rt.name AS template_name, up.granted_by AS granted_by, up.granted_at AS granted_at FROM users u LEFT JOIN user_roles ur ON u.id = ur.user_id LEFT JOIN role_templates rt ON ur.template_id = rt.id LEFT JOIN role_template_permissions rtp ON rt.id = rtp.template_id LEFT JOIN permissions p ON rtp.permission_id = p.id LEFT JOIN user_permissions up ON u.id = up.user_id WHERE u.id IS NOT NULL; SELECT 'User permissions view refreshed successfully' AS status; END;;
DELIMITER ;

-- Function: GetUserActivityScore
DROP FUNCTION IF EXISTS `GetUserActivityScore`;
DELIMITER ;;
CREATE FUNCTION `GetUserActivityScore`(p_user_id INT, p_days INT) RETURNS decimal(5,2) READS SQL DATA DETERMINISTIC BEGIN DECLARE v_score DECIMAL(5,2) DEFAULT 0.0; DECLARE v_total_actions INT DEFAULT 0; DECLARE v_unique_days INT DEFAULT 0; DECLARE v_avg_daily_actions DECIMAL(5,2) DEFAULT 0.0; -- Get total actions in last N days SELECT COUNT(*) INTO v_total_actions FROM comprehensive_audit_trail WHERE user_id = p_user_id AND timestamp >= DATE_SUB(NOW(), INTERVAL p_days DAY); -- Get unique active days SELECT COUNT(DISTINCT DATE(timestamp)) INTO v_unique_days FROM comprehensive_audit_trail WHERE user_id = p_user_id AND timestamp >= DATE_SUB(NOW(), INTERVAL p_days DAY); -- Calculate score (0-100) IF v_unique_days > 0 THEN SET v_avg_daily_actions = v_total_actions / v_unique_days; SET v_score = LEAST(100, (v_unique_days * 10) + (v_avg_daily_actions * 2)); END IF; RETURN v_score; END;;
DELIMITER ;

-- Function: GetUserPermissions
DROP FUNCTION IF EXISTS `GetUserPermissions`;
DELIMITER ;;
CREATE FUNCTION `GetUserPermissions`(user_id_param INT) RETURNS text CHARSET utf8mb4 COLLATE utf8mb4_general_ci READS SQL DATA DETERMINISTIC BEGIN DECLARE result TEXT DEFAULT ''; SELECT GROUP_CONCAT(DISTINCT permission_name ORDER BY permission_name SEPARATOR ',') INTO result FROM user_permissions_view WHERE user_id = user_id_param; RETURN COALESCE(result, ''); END;;
DELIMITER ;

-- Function: GetUserTemplates
DROP FUNCTION IF EXISTS `GetUserTemplates`;
DELIMITER ;;
CREATE FUNCTION `GetUserTemplates`(user_id_param INT) RETURNS text CHARSET utf8mb4 COLLATE utf8mb4_general_ci READS SQL DATA DETERMINISTIC BEGIN DECLARE result TEXT DEFAULT ''; SELECT GROUP_CONCAT(rt.name ORDER BY rt.name SEPARATOR ',') INTO result FROM user_roles ur JOIN role_templates rt ON ur.template_id = rt.id WHERE ur.user_id = user_id_param; RETURN COALESCE(result, ''); END;;
DELIMITER ;

-- Function: HasPermission
DROP FUNCTION IF EXISTS `HasPermission`;
DELIMITER ;;
CREATE FUNCTION `HasPermission`(user_id_param INT, permission_name_param VARCHAR(100)) RETURNS tinyint(1) READS SQL DATA DETERMINISTIC BEGIN DECLARE permission_count INT DEFAULT 0; SELECT COUNT(*) INTO permission_count FROM user_permissions_view WHERE user_id = user_id_param AND permission_name = permission_name_param; RETURN permission_count > 0; END;;
DELIMITER ;

COMMIT;
SET FOREIGN_KEY_CHECKS = 1;
SET AUTOCOMMIT = 1;

-- ================================================
-- Export completed at: 2025-09-06 13:50:32
-- ================================================
